
<script src="${static_js_uri}/plugins/echart2/echarts-all.js"></script>
<script src="${static_js_uri}/plugins/talk.js"></script>
<script src="${static_js_uri}/plugins/showChart.js"></script>
<script src="${static_js_uri}/plugins/codeAutoTip.js"></script>
<script src="${static_js_uri}/plugins/bookmark.js"></script>
<script type="text/javascript">
	// 基于准备好的dom，初始化echarts图表

	var StockData = "";
	var talkListInit = 0;
	
	// 全局
	var StockCodeName="";
	var straListData = [];
	var nowTId = 0;
	var selectStraId = 0;
	
	// 全局;
	var StockInfoData;
	var StockCode = "";
	var StockSid = 0;	

	jQuery(function($) {
		
		getStockData("hs300");
		
		getPage(1);
		
		CodeAuto();
		
		ListBookMarksCode(1, ${Step_Type!1});

		$("#listtab1").click(function() {
			StockCode = "";
			StockSid = straListData[nowTId]['id'];
		});

		$("#listtab2").click(function() {
			StockCode = $("#code_num").val();			
			StockSid = 0;
		});
	});

	function addCode(o, n) {
		$("#code_num").val(o);

		$("#talkNameCode").html("<i class='fa fa-bar-chart-o'></i>" + o + " " + n);
		$("#talkNameCode").attr("class", "");

		$("#talkNameCode").focus();

		console.log("code:" + o);

		// 获取股票的讨论内容
		listTalk(0, 0, o);

		talkSelect(0);
		StockCode = o
		StockCodeName = n;
	}

	function istrSelect(i) {
		for (n = 0; n < 5; n++) {
			$("#select_" + n).attr("class", "fa fa-close");
		}

		$("#select_" + i).attr("class", "fa fa-check");
		
		for (n = 0; n < 3; n++) {
			$("#bmslist_" + n).attr("class", "fa fa-close");
		}

		selectStraId = straListData[i]['id'];
		var name = straListData[i]['title'];
		nowTId = i;
		$("#strategy_name").html(name);

		$("#talkNameStra").html("<i class='fa fa-flask'></i>" + name);

		$("#comment-sid").val(straListData[i]['id']);
		//console.log("sid:" + straListData[i]['id']);

		// 获取策略的讨论内容
		listTalk(0, straListData[i]['id'], "");

		talkSelect(1, straListData[nowTId]['id']);
	}
	
	
	function istrSelect2(name, sid, i) {
		for (n = 0; n < 5; n++) {
			$("#select_" + n).attr("class", "fa fa-close");
		}
		
		for (n = 0; n < 3; n++) {
			$("#bmslist_" + n).attr("class", "fa fa-close");
		}
		$("#bmslist_" + i).attr("class", "fa fa-check");
		
		selectStraId = sid;
		
		$("#strategy_name").html(name);

		$("#talkNameStra").html("<i class='fa fa-flask'></i>" + name);

		$("#comment-sid").val(sid);
		//console.log("sid:" + straListData[i]['id']);

		// 获取策略的讨论内容
		listTalk(0, sid, "");

		talkSelect(1, sid);
	}
	

	function getPage(p) {
		
		$.ajax({
					url : "/etomc2/strapage?jsoncallback=?",
					contentType : 'text/html;charset=utf-8',

					data : {
						"cid" : ${Step_Type!1},
						"p" : p
					},
					success : function(result) {
						//console.log("success" + result);
					},
					error : function(request, textStatus, errorThrown) {
						//alert(textStatus);
					},
					complete : function(request, textStatus) { //for additional info
						var option = request.responseText;
						//console.log("option:" + option);
						var Json = JSON.parse(option);
						$("#straPage").html(Json['page']);
						//console.log("option:" + Json['data']);
																							
						var ListStrHtml = "";
						for (i = 0; i < Json['data'].length; i++) {
							var fa = "fa-close";
																					
							if(selectStraId == Json['data'][i]['id']){
								fa = "fa-check";
							}
														
							var inte = Json['data'][i]['integral'];
							var insval = "";
							if (inte == 0) {
								insval = '免费';
							} else {
								insval = inte + ' 积分';
							}

							ListStrHtml += "<tr>"
									+ "<th scope='row'>"
									+ (i + 1)
									+ "</th>"
									+ "<td>"
									+ Json['data'][i]['title']
									+ "</td>"
									+ "<td>"
									+ Json['data'][i]['follow']
									+ "</td>"
									//+ "<td>"
									//	+ Json['data'][i]['income']
									//	+ "</td>"
									+ "<td>"
									+ insval
									+ "</td>"
									+ "<td>"
									+ Json['data'][i]['nickname']
									+ "</td>"
									+ "<td><button title='Success' class='btn btn-outline btn-success' type='button' onclick='istrSelect("
									+ i
									+ ")'>"
									+ "		<i class='fa "+fa+"' id='select_"+i+"' name='select_"+i+"'></i> <span class='sr-only'>Success</span>"
									+ "	</button></td>" + "</tr>";
						}

						$("#straList").html(ListStrHtml);
						//console.log("talkListInit:" + talkListInit);
						straListData = Json['data'];
						var name = straListData[0]['title'];
						
						if (talkListInit == 0) {
							listTalk(0, straListData[0]['id'], "");
							talkListInit = 1;
							istrSelect(0);
							$("#talkNameStra").html(
									"<i class='fa fa-flask'></i>" + name);
						}
						
					}
				});
	}

	function Tactics() {
		var code = $("#code_num").val();
		if (code.length == 0) {
			alert("请填写代码");
			return;
		}
		$.ajax({
			url : "/etomc2/ptactics?jsoncallback=?",
			contentType : 'text/html;charset=utf-8',

			data : {
				"code" : code,
				"iid" : straListData[nowTId]['iid'],
				"path" : straListData[nowTId]['path'],
			},
			success : function(result) {
				//console.log("success" + result);
			},
			error : function(request, textStatus, errorThrown) {
				//alert(textStatus);
			},
			complete : function(request, textStatus) { //for additional info
				var option = request.responseText;

				if (option.length > 0) {
					var oldOption = getChartOption();

					var stock = option.split("@");
					var codeJson = JSON.parse(stock[0]);
					var hs300 = JSON.parse(stock[1]);
					var legendName = oldOption['legend']['data'];
					var selected = {};
					for (var n = 0; n < legendName.length; n++) {
						selected[legendName[n]] = false;
					}
					oldOption['legend']['selected'] = selected;

					//var DateList=oldOption['legend']['data'];
					var seriesList = oldOption['series'];

					//legendName.push("600808");
					legendName.push("hs300");
					var hsReturn = hs300['returns'];
					//console.log("hs300:" + hs300['returns']);
					//console.log("hs300 sell:" + hs300['sell']);
					var hsData = [];
					for ( var k in hsReturn) {
						//console.log("hs300 k:" + hsReturn[k]['time']);
						//DateList.push(hsReturn[k]['time']);
						hsData.push(hsReturn[k]['item']);
					}
					var seriesData = {};
					seriesData['name'] = "hs300";
					seriesData['type'] = "line";
					seriesData['data'] = hsData;
					seriesData['yAxisIndex'] = 1;
					seriesList.push(seriesData);

					legendName.push(code);
					var cReturn = codeJson['returns'];
					//console.log("hs300:" + hs300['returns']);
					//console.log("hs300 sell:" + hs300['sell']);
					var cData = [];
					for ( var k in cReturn) {
						//console.log("hs300 k:" + cReturn[k]['time']);

						cData.push(cReturn[k]['item']);
					}
					var cseriesData = {};
					cseriesData['name'] = code;
					cseriesData['type'] = "line";
					cseriesData['data'] = cData;
					cseriesData['yAxisIndex'] = 1;
					seriesList.push(cseriesData);

					var profit = codeJson["profit"];
					$("#iprofit").html(profit + "<span>年化收益</span>");
					var sharpe = codeJson["sharpe"];
					$("#isharpe").html(sharpe + "<span>夏普比率</span>");
					var maxDraw = codeJson['maxDraw'];
					$("#iMaxDrawDown").html(maxDraw + "<span>最大回撤</span>");

					var beta = codeJson['alpha']['beta'];
					$("#ibeta").html(beta + "<span>贝塔</span>");

					var alpha = codeJson['alpha']['alpha'];
					$("#ialpha").html(alpha + "<span>阿尔法</span>");

					//console.log("option:" + Json['returns']);
					var name = straListData[nowTId]['title'];
					$("#tactics").html(name);
					$("#icode").html(code);

					oldOption['legend']['data'] = legendName;
					oldOption['series'] = seriesList;
					console.log("oldOption:"
							+ JSON.stringify(oldOption['legend']['data']));

					//  console.log("JsonOpton:" +JSON.stringify(oldOption)  );

					ChartRefresh(oldOption);
				}
			}
		});

	}
	

</script>


