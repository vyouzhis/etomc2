<script src="${static_js_uri}/plugins/echart2/echarts-all.js${StaticVer}"></script>
<script src="${static_js_uri}/plugins/md5/jquery.md5.js${StaticVer}"></script>
<script src="${static_js_uri}/plugins/etomc2_gather.js${StaticVer}"></script>
<script>
	var StockCid = ${Step_Type!1};	
	StockMd = 1;
	ToolTip = false;
	var DomainUrl = "";
	getStockData("hs300");

	/**
	 *  测试在首页 的 变量
	 */
	${root_var!""}

	$(document).ready(function() {
		$("form").submit(function(e) {
			chkForm();
		});
	});

	function chkForm() {
		var passwd = $("#Password").val();
		var salt = $("#salt").val();
		var md5 = $.md5($.md5(passwd) + salt);
		$("#Password").val(md5);
	}

	function changeCode() {
		$('#kaptchaImage').attr('src',
				'/etomc2/captcha_image?' + Math.floor(Math.random() * 100))
				.fadeIn();
	}
</script>



<script type="text/javascript">
	var webSocket;

	openSocket();
	
	function openSocket() {
		// Ensures only one connection is open at a time
		if (webSocket !== undefined
				&& webSocket.readyState !== WebSocket.CLOSED) {
			writeResponse("WebSocket is already opened.");
			return;
		}
		// Create a new instance of the websocket
		webSocket = new WebSocket("ws://w.etomc2.com:8080/etomc2");
	 
		/**
		 * Binds functions to the listeners for the websocket.
		 */
		webSocket.onopen = function(event) {
			// For reasons I can't determine, onopen gets called twice
			// and the first time event.data is undefined.
			// Leave a comment if you know the answer.
			if (event.data === undefined)
				return;

			writeResponse(event.data);
		};

		webSocket.onmessage = function(event) {
			writeResponse(event.data);
		};

		webSocket.onclose = function(event) {
			writeResponse("-1");
		};
	}

	/**
	 * Sends the value of the text input to the server
	
	function send(){
	    var text = document.getElementById("messageinput").value;
	    webSocket.send(text);
	}*/
	
	function closeSocket(){
	    webSocket.close();
	}  

	function AjaxInitDB() {
		
		$.ajax({
					url : DomainUrl+"/ptactics?jsoncallback=?",
					contentType : 'text/html;charset=utf-8',
					data : {
						"act" : 1,
					},
					success : function(result) {
						// console.log("success" + result);
					},
					error : function(request, textStatus, errorThrown) {
						// alert(textStatus);
					},
					complete : function(request, textStatus) { // for additional
																// info
						var option = request.responseText;
						if(option.length < 5) return;
						writeResponse(option);
					}
				});
		
		//每隔4秒，读取一次.
	    setTimeout('AjaxInitDB()', 120000);
	}
	
	function writeResponse(text) {
		if(text == "-1"){
			console.log("only ajax:");
			AjaxInitDB();
			return;
		}
		
		if(text.length < 30)return;
		var sdb = text.replace(/u'/g, "'");
		sdb = sdb.replace(/'/g, "\"");
		
		var StockJson = JSON.parse(sdb);
		
		var html = "";
		for(var i=0; i<StockJson.length; i++){
			
			var val = StockJson[i]['price'] - StockJson[i]['pre_close'];
			val = val.toFixed(2);
			
			var pec = val/StockJson[i]['open'] * 100;
			pec = pec.toFixed(2);
			
			var isUp = "up";
			if(val < 0){
				isUp = "down";
			}
			html += "<div class='knowledge'>"+
							"<h2>"+
							"<a href='#' >"+ StockJson[i]['name']+ "<span class='pull-right "+isUp+"' ><i class='fa fa-long-arrow-"+isUp+" pull-left'></i>"+ StockJson[i]['price']+"</span></a>"+
						"</h2>"+
						"<div class='row '>"+
							"<div class= 'col-sm-6 col-xs-6'>"+
							"<h4 class='"+isUp+"'>"+ val +"</h4></div>"+
							"<div class= 'col-sm-6 col-xs-6 text-right'>"+
							"<h4 class='"+isUp+"'>"+pec+"%</h4></div>"+
						"</div>"+
					"</div>";
		}
		$("#loop_data").html(html);
	}
	
	
</script>